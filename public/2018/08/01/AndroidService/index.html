<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Service,startService,bindService" />





  <link rel="alternate" href="/atom.xml" title="放码过来" type="application/atom+xml" />






<meta name="description" content="《Android开发艺术探索》9.3章Service分为两种工作状态,一种是启动状态，主要用于执行后台计算;另一种是绑定态,主要用于其他组件和Service的交互。需要注意的是，Service的这两种状态是可以共存的，即Service既可以处于启动状态也可以同时处于绑定状态。通过Context的startService方法即可启动一个Service:12Intent intent = new In">
<meta property="og:type" content="article">
<meta property="og:title" content="AndroidService">
<meta property="og:url" content="http://blog.huangyuanlove.com/2018/08/01/AndroidService/index.html">
<meta property="og:site_name" content="放码过来">
<meta property="og:description" content="《Android开发艺术探索》9.3章Service分为两种工作状态,一种是启动状态，主要用于执行后台计算;另一种是绑定态,主要用于其他组件和Service的交互。需要注意的是，Service的这两种状态是可以共存的，即Service既可以处于启动状态也可以同时处于绑定状态。通过Context的startService方法即可启动一个Service:12Intent intent = new In">
<meta property="og:updated_time" content="2018-08-04T04:46:23.080Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AndroidService">
<meta name="twitter:description" content="《Android开发艺术探索》9.3章Service分为两种工作状态,一种是启动状态，主要用于执行后台计算;另一种是绑定态,主要用于其他组件和Service的交互。需要注意的是，Service的这两种状态是可以共存的，即Service既可以处于启动状态也可以同时处于绑定状态。通过Context的startService方法即可启动一个Service:12Intent intent = new In">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.huangyuanlove.com/2018/08/01/AndroidService/"/>





  <title>AndroidService | 放码过来</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-123314537-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?98796e1ecbcbaac6a6d9d3fea85985ba";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">放码过来</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术宅 huangyuan@huangyuanlove.com</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'LoCFNsvjbeYQpYd-Wuxs','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.huangyuanlove.com/2018/08/01/AndroidService/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuangYuan_xuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/4216225?v=3&s=466">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="放码过来">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">AndroidService</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-01T10:01:16+08:00">
                2018年08月01日
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,929
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  42
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>《Android开发艺术探索》9.3章<br><code>Service</code>分为两种工作状态,一种是启动状态，主要用于执行后台计算;另一种是绑定态,主要用于其他组件和<code>Service</code>的交互。需要注意的是，<code>Service</code>的这两种状态是可以共存的，即<code>Service</code>既可以处于启动状态也可以同时处于绑定状态。<br>通过<code>Context</code>的<code>startService</code>方法即可启动一个<code>Service</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(content,Service.class);</div><div class="line">startService(intent);</div></pre></td></tr></table></figure></p>
<p>通过<code>Context</code>的<code>bindService</code>方法可以绑定一个<code>Service</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(content,Service.class);</div><div class="line">bindService(intent,connection,BIND_AUTO_CREATE);</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h4 id="Service启动过程"><a href="#Service启动过程" class="headerlink" title="Service启动过程"></a>Service启动过程</h4><p><code>Service</code>的启动时从<code>ContextWrapper</code>的<code>startService</code>开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mBase.startService(service);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>mBase</code>是<code>Context</code>的实现类<code>ContextImpl</code>，<code>在Activity</code>启动的时候会通过<code>attach</code>方法关联一个<code>ContextImpl</code>，这个<code>ContextImpl</code>就是上面的<code>mBase</code>，从<code>ContextWrapper</code>的实现来看，大部分的实现都是通过<code>mBase</code>来实现的，这是一种典型的桥接模式。在<code>ContextImpl</code>的<code>startService</code>方法中又调用了<code>startServiceCommon</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">        warnIfCallingFromSystemProcess();</div><div class="line">        <span class="keyword">return</span> startServiceCommon(service, <span class="keyword">false</span>, mUser);</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, <span class="keyword">boolean</span> requireForeground,UserHandle user)</span> </span>&#123;</div><div class="line"></div><div class="line">    validateServiceIntent(service);</div><div class="line">    service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">    <span class="comment">//api 27</span></div><div class="line">    ComponentName cn = ActivityManager.getService().startService(</div><div class="line">        mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</div><div class="line">                    getContentResolver()), requireForeground,</div><div class="line">                    getOpPackageName(), user.getIdentifier());</div><div class="line">    <span class="comment">//api 25</span></div><div class="line">    <span class="comment">//ComponentName cn = ActivityManagerNative.getDefault().startService(</span></div><div class="line">     <span class="comment">//   mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span></div><div class="line">      <span class="comment">//  getContentResolver()), getOpPackageName(), user.getIdentifier());</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> cn;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>startServiceCommon</code>中通过<code>getService</code>这个对象来启动一个服务，这个对象就是AMS，需要注意的是，在上述代码中通过AMS来启动服务的过程是一个跨进程调用。AMS的<code>startService</code>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></div><div class="line">            String resolvedType, String callingPackage, <span class="keyword">int</span> userId)</div><div class="line">            <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">            ComponentName res = mServices.startServiceLocked(caller, service,</div><div class="line">                    resolvedType, callingPid, callingUid, callingPackage, userId);</div><div class="line">            Binder.restoreCallingIdentity(origId);</div><div class="line">            <span class="keyword">return</span> res;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>AMS会通过<code>mServices</code>来完成<code>service</code>的启动过程，<code>mServices</code>的对象类型是<code>ActiveServices</code>，<code>ActiveServices</code>是一个辅助AMS进行<code>Service</code>管理的类，包括<code>Service</code>的启动、绑定和停止。在<code>startService</code>方法的尾部会调用<code>startServiceInnerLocked</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></div><div class="line">            <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">        ServiceState stracker = r.getTracker();</div><div class="line">        <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</div><div class="line">            stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</div><div class="line">        &#125;</div><div class="line">        r.callStart = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">            r.stats.startRunningLocked();</div><div class="line">        &#125;</div><div class="line">        String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> r.name;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上述代码中<code>ServiceRecord</code>是描述一个Service记录，<code>ServiceRecord</code>一直贯穿整个Service流程，<code>startServiceInnerLocked</code>并没有完成启动Service的完整流程，而是将后续的过程交给了<code>bringUpServiceLocked</code>，在该方法中又调用了<code>realStartServiceLocked</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></div><div class="line">            ProcessRecord app, <span class="keyword">boolean</span> execInFg) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">       </div><div class="line">        r.app = app;</div><div class="line">        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</div><div class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</div><div class="line">        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        mAm.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">                r.stats.startLaunchedLocked();</div><div class="line">            &#125;</div><div class="line">            mAm.notifyPackageUse(r.serviceInfo.packageName,</div><div class="line">                                 PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</div><div class="line">            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                    app.repProcState);</div><div class="line">            r.postNotification();</div><div class="line">            created = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</div><div class="line">            mAm.appDiedLocked(app);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!created) &#123;</div><div class="line">                <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line"></div><div class="line">                <span class="comment">// Cleanup.</span></div><div class="line">                <span class="keyword">if</span> (newService) &#123;</div><div class="line">                    app.services.remove(r);</div><div class="line">                    r.app = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Retry.</span></div><div class="line">                <span class="keyword">if</span> (!inDestroying) &#123;</div><div class="line">                    scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.whitelistManager) &#123;</div><div class="line">            app.whitelistManager = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        requestServiceBindingsLocked(r, execInFg);</div><div class="line"></div><div class="line">        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If the service is in the started state, and there are no</span></div><div class="line">        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></div><div class="line">        <span class="comment">// be called.</span></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</div><div class="line">            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayed) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</div><div class="line">            getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">            r.delayed = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayedStop) &#123;</div><div class="line">            <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">            r.delayedStop = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (r.startRequested) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</div><div class="line">                        <span class="string">"Applying delayed stop (from start): "</span> + r);</div><div class="line">                stopServiceLocked(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在<code>realStartServiceLocked</code>方法中，首先通过<code>app.thread</code>的<code>scheduleCreateService</code>方法来创建<code>Service</code>对象并调用其<code>onCreate</code>,接着再通过<code>sendServiceArgsLocked</code>方法来调用<code>Service</code>的其他方法，比如<code>onStartCommand</code>,这两个过程均是进程间通信。<code>app.thread</code>对象是<code>IApplicationThread</code>类型，它实际上是一个<code>Binder</code>,它的具体实现是<code>ApplicationThread</code>和<code>ApplicationThreadNative</code>。由于<code>ApplicationThread</code>继承了<code>ApplicationThreadNative</code>,因此只需要看<code>ApplicationThread</code>对<code>Service</code>启动过程的处理即可，这对应着它的<code>scheduleCreateService</code>方法，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></div><div class="line">               ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState) &#123;</div><div class="line">           updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">           CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</div><div class="line">           s.token = token;</div><div class="line">           s.info = info;</div><div class="line">           s.compatInfo = compatInfo;</div><div class="line"></div><div class="line">           sendMessage(H.CREATE_SERVICE, s);</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>通过发送消息给<code>Handler H</code>来完成的。H会接收这个<code>CREATE_ SERVICE</code>消息并通过<code>ActivityThread</code>的<code>handleCreateService</code>方法来完成Service的最终启动，<code>handleCreateService</code>的源码如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</div><div class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">        <span class="comment">// we are back active so skip it.</span></div><div class="line">        unscheduleGcIdler();</div><div class="line">        LoadedApk packageInfo = getPackageInfoNoCheck(</div><div class="line">                data.info.applicationInfo, data.compatInfo);</div><div class="line">        Service service = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            java.lang.ClassLoader cl = packageInfo.getClassLoader();</div><div class="line">            service = (Service) cl.loadClass(data.info.name).newInstance();</div><div class="line"></div><div class="line">            ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</div><div class="line">            context.setOuterContext(service);</div><div class="line"></div><div class="line">            Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line">            service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</div><div class="line">                    ActivityManagerNative.getDefault());</div><div class="line">            service.onCreate();</div><div class="line">            mServices.put(data.token, service);</div><div class="line">            ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                        data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>handleCreateService</code>主要完成了以下几件事：<br>首先通过类加载器创建了Service实例，接着创建<code>ContextImpl</code>对象和<code>Application</code>对象  并通过service.attach方法建立联系，最后调用<code>service.onCreate</code>方法，并将<code>service</code>存储在<code>ActivityThread</code>中的一个列表<code>mServices</code>中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Service&gt; mServices = <span class="keyword">new</span> ArrayMap&lt;&gt;();</div></pre></td></tr></table></figure></p>
<p>由于<code>service</code>的<code>onCreate</code>方法执行了，也就意味着<code>Service</code>已经启动了。除此之外，<code>ActivityThead</code>中还会通过<code>handleServiceArgs</code>方法调用<code>Service</code>的<code>onStartCommand</code>方法。</p>
<h4 id="Service绑定过程"><a href="#Service绑定过程" class="headerlink" title="Service绑定过程"></a>Service绑定过程</h4><p>和启动过程一样，也是从<code>ContextWrapper</code>开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">        <span class="keyword">int</span> flags) &#123;</div><div class="line">    <span class="keyword">return</span> mBase.bindService(service, conn, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后是<code>ContextImpl</code>的<code>bindService</code>方法调用<code>bindServiceCommon</code>方法，然后远程调用AMS的<code>bindService</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler handler, UserHandle user)</span> </span>&#123;</div><div class="line">    <span class="comment">// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span></div><div class="line">    IServiceConnection sd;</div><div class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</div><div class="line">    &#125;</div><div class="line">    validateServiceIntent(service);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        IBinder token = getActivityToken();</div><div class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></div><div class="line">                &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">            flags |= BIND_WAIVE_PRIORITY;</div><div class="line">        &#125;</div><div class="line">        service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">int</span> res = ActivityManager.getService().bindService(</div><div class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">            service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">            sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                    <span class="string">"Not allowed to bind to service "</span> + service);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在该方法中，首先将客户端的<code>ServiceConnection</code>转化为<code>ServiceDispatcher.InnerConnection</code>对象，因为服务绑定是跨进程的，所以<code>ServiceConnection</code>对象必须借助<code>Binder</code>对象才能让远程服务端调用自己的方法。<code>ServiceDispatcher</code>起着连接<code>ServiceConnection</code>和<code>InnerConnection</code>的作用。这个过程由<code>LoadedApk.getServiceDispatcher</code>方法完成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span><span class="params">(ServiceConnection c,</span></span></div><div class="line">            Context context, Handler handler, <span class="keyword">int</span> flags) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mServices) &#123;</div><div class="line">            LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</div><div class="line">            ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</div><div class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Returning existing dispatcher "</span> + sd + <span class="string">" for conn "</span> + c);</div><div class="line">                sd = map.get(c);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (sd == <span class="keyword">null</span>) &#123;</div><div class="line">                sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</div><div class="line">                <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Creating new dispatcher "</span> + sd + <span class="string">" for conn "</span> + c);</div><div class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">                    map = <span class="keyword">new</span> ArrayMap&lt;&gt;();</div><div class="line">                    mServices.put(context, map);</div><div class="line">                &#125;</div><div class="line">                map.put(c, sd);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                sd.validate(context, handler);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sd.getIServiceConnection();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在上面的代码中，<code>mServices</code>是一个<code>ArrayMap</code>，它存储了一个应用当前活动的<code>ServiceConnection</code>和<code>ServiceDispatcher</code>的映射关系，其声明如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices</div><div class="line">        = <span class="keyword">new</span> ArrayMap&lt;&gt;();</div></pre></td></tr></table></figure></p>
<p>系统首先会查找是否存在相同的<code>ServiceConnection</code>,如果不存在就重新创建一个<code>ServiceDispatcher</code>对象，并将其存储在<code>mServices</code>中，其中映射关系的key是<code>ServiceConnection</code>,value是<code>ServiceDispatcher</code>,在<code>ServiceDispatcher</code>的内部又保存了<code>ServiceConnection</code>和<code>InnerConnection</code>对象。当<code>Service</code>和客户端建立连接后，系统会通过<code>InnerConnection</code>来调用<code>ServiceConnection</code>中的<code>onServiceConnected</code>方法，这个过程有可能是跨进程的。当<code>ServiceDispatcher</code>创建好了以后，<code>getServiceDispatcher</code>会 返回其保存的<code>InnerConnection</code>对象。<br>接着调用AMS的<code>bindService</code>  方法，该方法又调用了<code>bindServiceLocked</code>–&gt;<code>bringUpServiceLocked</code>–&gt;<code>realStartServiceLocked</code>，这个过程和上面的<code>StartService</code>过程逻辑类似，最终都是通过<code>ApplicationThread</code>来完成<code>Service</code>的实例创建并调用<code>onCreate</code>方法。和启动<code>Service</code>过程不同的是，绑定过程会调用<code>app.thread</code>的<code>scheduleBindService</code>方法，这个过程的实现在<code>ActivityService</code>的<code>requestServiceBindingsLocked</code>方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestServiceBindingsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg)</span></span></div><div class="line">           <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=r.bindings.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">           IntentBindRecord ibr = r.bindings.valueAt(i);</div><div class="line">           <span class="keyword">if</span> (!requestServiceBindingLocked(r, ibr, execInFg, <span class="keyword">false</span>)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>该方法用到了<code>r.bindings</code>。它是一个<code>ArrayMap</code>，保存了客户端的<code>bind</code>消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt; bindings = <span class="keyword">new</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt;();</div></pre></td></tr></table></figure></p>
<p>具体保存方法在AMS一开始的方法<code>bindServiceLocked</code>中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</div></pre></td></tr></table></figure></p>
<p>在<code>requestServiceBindingsLocked</code>方法中调用了了<code>requestServiceBindingLocked</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></div><div class="line">            <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind) <span class="keyword">throws</span> TransactionTooLargeException &#123;</div><div class="line">        <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// If service is not currently running, can't yet bind.</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.d(TAG_SERVICE, <span class="string">"requestBind "</span> + i + <span class="string">": requested="</span> + i.requested</div><div class="line">                + <span class="string">" rebind="</span> + rebind);</div><div class="line">        <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</div><div class="line">                r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">                r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</div><div class="line">                        r.app.repProcState);</div><div class="line">                <span class="keyword">if</span> (!rebind) &#123;</div><div class="line">                    i.requested = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                i.hasBound = <span class="keyword">true</span>;</div><div class="line">                i.doRebind = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">                <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</div><div class="line">                <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在上述代码中，<code>app.thread</code>这个对象多次出现过，它实际上就是<code>ApplicationThread</code>。<code>ApplicationThread</code>的一系列以<code>schedule</code>开头的方法，其内部都是通过<code>Handler H</code>来中转的，对于<code>scheduleBindService</code>方法来说也是如此，它的实现如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent,</span></span></div><div class="line">                <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState) &#123;</div><div class="line">            updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">            BindServiceData s = <span class="keyword">new</span> BindServiceData();</div><div class="line">            s.token = token;</div><div class="line">            s.intent = intent;</div><div class="line">            s.rebind = rebind;</div><div class="line">            sendMessage(H.BIND_SERVICE, s);</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>在H内部，接收到<code>BIND_SERVICE</code>这类消息时，会交给<code>ActivityThread</code>的<code>handleBindService</code>方法来处理。在<code>handleBindService</code>中，首先根据<code>Service</code>的<code>token</code>取出<code>Service</code>对象，然后调用<code>Service</code>的<code>onBind</code>方法，<code>Service</code>的<code>onBind</code>方法会返回一个<code>Binder</code>对象给客户端使用，原则上来说，<code>Service</code>的<code>onBind</code>方法被调用以后，<code>Service</code>就处于绑定状态了，但是<code>onBind</code>方法是<code>Service</code>的方法，这个时候客户端并不知道已经成功连接<code>Service</code>了，所以还必须调用客户端的<code>ServiceConnection</code>中的<code>onServiceConnected</code>,这个过程是由<code>ActivityManager.getService()</code>的<code>publishService</code>方法来完成的，而前面多次提到，<code>ActivityManager.getService()</code>就是AMS。<code>handleBindService</code>的实现过程如下所示。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</div><div class="line">        Service s = mServices.get(data.token);</div><div class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">                data.intent.prepareToEnterProcess();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (!data.rebind) &#123;</div><div class="line">                        IBinder binder = s.onBind(data.intent);</div><div class="line">                        ActivityManager.getService().publishService(</div><div class="line">                                data.token, data.intent, binder);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        s.onRebind(data.intent);</div><div class="line">                        ActivityManager.getService().serviceDoneExecuting(</div><div class="line">                                data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                    &#125;</div><div class="line">                    ensureJitEnabled();</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">                    <span class="keyword">throw</span> ex.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                            <span class="string">"Unable to bind to service "</span> + s</div><div class="line">                            + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>Service有一个特性，当多次绑定同一个Service时，Service的<code>onBind</code>方法<strong>只会执行一次</strong>，除非Service被终止了。当Service的onBind执行以后，系统还需要告知客户端已经成功连接Service了。根据上面的分析，这个过程由AMS的<code>publishService</code>方法来实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</div><div class="line">            &#125;</div><div class="line">            mServices.publishServiceLocked((ServiceRecord)token, intent, service);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>从_上面代码可以看出，AMS的<code>publishService</code>方法将具体的工作交给了<code>ActiveServices</code>类型的<code>mServices</code>对象来处理。<code>ActiveServices</code>的<code>publishServiceLocked</code>方法看起来很复杂，但其实核心代码就只有一- 句话: <code>c.conn.connected(r.name,service)</code>， 其中c的类型是<code>ConnectionRecord</code>，<code>c.comn</code>的类型是<code>ServiceDispatcher.InnerConnection</code>, service就是Service的onBind方法返回的Binder对象。为了分析具体的逻辑，下面看一下<code>ServiceDispatcher.InnerConnection</code>的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</div><div class="line"></div><div class="line">            InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</div><div class="line">                mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service, <span class="keyword">boolean</span> dead)</span></span></div><div class="line">                    <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">                LoadedApk.ServiceDispatcher sd = mDispatcher.get();</div><div class="line">                <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line">                    sd.connected(name, service, dead);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>从<code>InnerConnection</code>的定义可以看出来，它的<code>connected</code>方法又调用了<code>ServiceDispatcher</code>的<code>connected</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service, <span class="keyword">boolean</span> dead)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</div><div class="line">                mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>, dead));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                doConnected(name, service, dead);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>对于Service的绑定过程来讲，<code>ServiceDispatcher</code>中的<code>mActivityThread</code>就是一个<code>handler</code>，它就是<code>ActivityThread</code>中的<code>H</code>，从<code>Service</code>的创建过程来讲，<code>mActivityTHread</code>不会为<code>null</code>，这样一来，<code>RunConnection</code>就可以经由<code>H</code>的<code>post</code>方法从而运行在主线程中，因此，客户端的<code>ServiceConnection</code>中的方法回调是在主线程中执行的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunConnection</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">            RunConnection(ComponentName name, IBinder service, <span class="keyword">int</span> command, <span class="keyword">boolean</span> dead) &#123;</div><div class="line">                mName = name;</div><div class="line">                mService = service;</div><div class="line">                mCommand = command;</div><div class="line">                mDead = dead;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mCommand == <span class="number">0</span>) &#123;</div><div class="line">                    doConnected(mName, mService, mDead);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCommand == <span class="number">1</span>) &#123;</div><div class="line">                    doDeath(mName, mService);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> ComponentName mName;</div><div class="line">            <span class="keyword">final</span> IBinder mService;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> mCommand;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> mDead;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>很显然，<code>RunConnection</code>的<code>run</code>方法也是简单调用了<code>ServiceDispatcher</code>的<code>doConnected</code>方法，由于<code>ServiceDispatcher</code>内部保存了客户端的<code>ServiceConnection</code>对象，因此它可以很方便地调用<code>ServiceConnection</code>对象的<code>onServiceConnected</code>方法，如下所示。<br>至此，bindService的过程完成。</p>
<hr>
<p>以上</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.png" alt="HuangYuan_xuan 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.png" alt="HuangYuan_xuan 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"><i class="fa fa-tag"></i> Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/31/Android广播/" rel="next" title="Android广播">
                <i class="fa fa-chevron-left"></i> Android广播
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/02/Android-ContentProvider/" rel="prev" title="Android ContentProvider">
                Android ContentProvider <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODYyMC8xNTE0OA"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/4216225?v=3&s=466"
                alt="HuangYuan_xuan" />
            
              <p class="site-author-name" itemprop="name">HuangYuan_xuan</p>
              <p class="site-description motion-element" itemprop="description">锱铢必较间接性奋发图强，睚眦必报持续性混吃等死</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/huangyuanlove" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:huangyuan@huangyuanlove.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Service启动过程"><span class="nav-number">1.</span> <span class="nav-text">Service启动过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Service绑定过程"><span class="nav-number">2.</span> <span class="nav-text">Service绑定过程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuangYuan_xuan</span>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数UV:<span id="busuanzi_value_site_uv"></span>PV:<span id="busuanzi_value_site_pv"></span>
</span>
</div>


  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">博客字数统计&#58;</span>
    
    <span title="博客字数统计">103.2k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>





        




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=65959286";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  
  


  

  

</body>
</html>
